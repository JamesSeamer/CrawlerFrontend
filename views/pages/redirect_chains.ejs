<%- include('../partials/header', { clients: [], activeClientId: null }) %>

<h1>Redirect Chains</h1>
<% if (typeof message !== 'undefined' && message) { %>
  <div class="alert alert-warning"><%= message %></div>
<% } %>

<table id="redirectTable" class="table table-striped table-bordered table-hover" style="width:100%">
  <thead class="table-primary">
    <tr>
      <th>Start URL</th>
      <th>Number of Redirects</th>
      <% 
        // Build URL_* columns safely even if redirects is empty
        const urlCols = (() => {
          if (!redirects || redirects.length === 0) return [];
          const nums = new Set();
          redirects.forEach(rc => {
            Object.keys(rc).forEach(k => {
              if (k.startsWith('URL_')) {
                const n = parseInt(k.split('_')[1], 10);
                if (!Number.isNaN(n)) nums.add(n);
              }
            });
          });
          return Array.from(nums).sort((a,b) => a - b).map(n => `URL_${n}`);
        })();
      %>
      <% urlCols.forEach(col => { %>
        <th><%= col %></th>
      <% }) %>
    </tr>
  </thead>
  <tbody>
    <% redirects.forEach(rc => { %>
      <tr>
        <td><a href="<%= rc.start_url %>" target="_blank" rel="noopener"><%= rc.start_url %></a></td>
        <td><%= rc.number_of_redirects || rc.Number_of_Redirects || 0 %></td>
        <% urlCols.forEach(col => { %>
          <td>
            <% if (rc[col]) { %>
              <a href="<%= rc[col] %>" target="_blank" rel="noopener"><%= rc[col] %></a>
            <% } %>
          </td>
        <% }) %>
      </tr>
    <% }) %>
  </tbody>
</table>

<script>
  $(function () {
    const opts = {
      responsive: true,
      pageLength: 10,
      layout: { topStart: 'pageLength', topEnd: 'search', bottomStart: 'info', bottomEnd: 'paging' },
      language: { searchPlaceholder: 'Searchâ€¦', search: '' }
    };
    $('#redirectTable').DataTable(opts);
  });
</script>

<%- include('../partials/footer') %>
