<%- include('../partials/header', { clients: [], activeClientId: activeCrawlId || null }) %>

<h1>Meta Checks</h1>
<% if (message) { %>
  <div class="alert alert-warning"><%= message %></div>
<% } %>

<ul class="nav nav-tabs" role="tablist" style="margin-bottom:1rem;">
  <li class="nav-item">
    <a class="nav-link active" data-bs-toggle="tab" href="#titleChecks" role="tab">
      Title Checks
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" data-bs-toggle="tab" href="#descChecks" role="tab">
      Description Checks
    </a>
  </li>
</ul>

<div class="tab-content">

  <!-- Title Checks -->
  <div class="tab-pane fade show active" id="titleChecks" role="tabpanel">

    <ul class="nav nav-tabs" role="tablist" style="margin-bottom:1rem;">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#over80" role="tab">> 80 characters (<%= over80.length %>)</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#under30" role="tab">< 30 characters (<%= under30.length %>)</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#missing" role="tab">Missing (<%= missing.length %>)</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#duplicates" role="tab">Duplicates (<%= duplicates.length %>)</a>
      </li>
    </ul>

    <div class="tab-content">
      <!-- Over 80 -->
      <div class="tab-pane fade show active" id="over80" role="tabpanel">
        <table id="tblOver80" class="table table-striped table-bordered table-hover">
          <thead class="table-primary">
            <tr>
              <th>ID</th>
              <th>Title (length)</th>
              <th>URL</th>
            </tr>
          </thead>
          <tbody>
            <% over80.forEach(r => { %>
              <tr>
                <td><%= r.id %></td>
                <td><%= (r.title||'') %> (<%= (r.title||'').trim().length %>)</td>
                <td><a href="<%= r.url %>" target="_blank"><%= r.url %></a></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <!-- Under 30 -->
      <div class="tab-pane fade" id="under30" role="tabpanel">
        <table id="tblUnder30" class="table table-striped table-bordered table-hover">
          <thead class="table-primary">
            <tr>
              <th>ID</th>
              <th>Title (length)</th>
              <th>URL</th>
            </tr>
          </thead>
          <tbody>
            <% under30.forEach(r => { %>
              <tr>
                <td><%= r.id %></td>
                <td><%= (r.title||'') %> (<%= (r.title||'').trim().length %>)</td>
                <td><a href="<%= r.url %>" target="_blank"><%= r.url %></a></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <!-- Missing -->
      <div class="tab-pane fade" id="missing" role="tabpanel">
        <table id="tblMissing" class="table table-striped table-bordered table-hover">
          <thead class="table-primary">
            <tr>
              <th>ID</th>
              <th>URL</th>
            </tr>
          </thead>
          <tbody>
            <% missing.forEach(r => { %>
              <tr>
                <td><%= r.id %></td>
                <td><a href="<%= r.url %>" target="_blank"><%= r.url %></a></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <!-- Duplicates -->
      <div class="tab-pane fade" id="duplicates" role="tabpanel">
        <table id="tblDuplicates" class="table table-striped table-bordered table-hover">
          <thead class="table-primary">
            <tr>
              <th>Title</th>
              <th>Count</th>
              <th>Pages</th>
            </tr>
          </thead>
          <tbody>
            <% duplicates.forEach(group => { %>
              <tr>
                <td><%= group.title %></td>
                <td><%= group.pages.length %></td>
                <td>
                  <ul style="margin:0; padding-left:1rem;">
                    <% group.pages.forEach(p => { %>
                      <li><strong><%= p.id %></strong> — <a href="<%= p.url %>" target="_blank"><%= p.url %></a></li>
                    <% }) %>
                  </ul>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Description Checks -->
  <div class="tab-pane fade" id="descChecks" role="tabpanel">

    <ul class="nav nav-tabs" role="tablist" style="margin-bottom:1rem;">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#over300desc" role="tab">> 300 characters (<%= over300desc.length %>)</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#under150desc" role="tab">< 150 characters (<%= under150desc.length %>)</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#missingdesc" role="tab">Missing (<%= missingdesc.length %>)</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#duplicatedesc" role="tab">Duplicates (<%= duplicatedesc.length %>)</a>
      </li>
    </ul>

    <div class="tab-content">
      <!-- Over 300 -->
      <div class="tab-pane fade show active" id="over300desc" role="tabpanel">
        <table id="tblOver300Desc" class="table table-striped table-bordered table-hover">
          <thead class="table-primary">
            <tr>
              <th>ID</th>
              <th>Description (length)</th>
              <th>URL</th>
            </tr>
          </thead>
          <tbody>
            <% over300desc.forEach(r => { %>
              <tr>
                <td><%= r.id %></td>
                <td><%= (r.meta_description||'') %> (<%= (r.meta_description||'').trim().length %>)</td>
                <td><a href="<%= r.url %>" target="_blank"><%= r.url %></a></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <!-- Under 150 -->
      <div class="tab-pane fade" id="under150desc" role="tabpanel">
        <table id="tblUnder150Desc" class="table table-striped table-bordered table-hover">
          <thead class="table-primary">
            <tr>
              <th>ID</th>
              <th>Description (length)</th>
              <th>URL</th>
            </tr>
          </thead>
          <tbody>
            <% under150desc.forEach(r => { %>
              <tr>
                <td><%= r.id %></td>
                <td><%= (r.meta_description||'') %> (<%= (r.meta_description||'').trim().length %>)</td>
                <td><a href="<%= r.url %>" target="_blank"><%= r.url %></a></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <!-- Missing -->
      <div class="tab-pane fade" id="missingdesc" role="tabpanel">
        <table id="tblMissingDesc" class="table table-striped table-bordered table-hover">
          <thead class="table-primary">
            <tr>
              <th>ID</th>
              <th>URL</th>
            </tr>
          </thead>
          <tbody>
            <% missingdesc.forEach(r => { %>
              <tr>
                <td><%= r.id %></td>
                <td><a href="<%= r.url %>" target="_blank"><%= r.url %></a></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <!-- Duplicates -->
      <div class="tab-pane fade" id="duplicatedesc" role="tabpanel">
        <table id="tblDuplicateDesc" class="table table-striped table-bordered table-hover">
          <thead class="table-primary">
            <tr>
              <th>Description</th>
              <th>Count</th>
              <th>Pages</th>
            </tr>
          </thead>
          <tbody>
            <% duplicatedesc.forEach(group => { %>
              <tr>
                <td><%= group.description %></td>
                <td><%= group.pages.length %></td>
                <td>
                  <ul style="margin:0; padding-left:1rem;">
                    <% group.pages.forEach(p => { %>
                      <li><strong><%= p.id %></strong> — <a href="<%= p.url %>" target="_blank"><%= p.url %></a></li>
                    <% }) %>
                  </ul>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    const opts = {
      responsive: true,
      pageLength: 10,
      layout: {
        topStart: 'pageLength',
        topEnd:   'search',
        bottomStart: 'info',
        bottomEnd:   'paging'
      },
      language: { searchPlaceholder: 'Search…', search: '' }
    };

    //titles
    $('#tblOver80').DataTable(opts);
    $('#tblUnder30').DataTable(opts);
    $('#tblMissing').DataTable(opts);
    $('#tblDuplicates').DataTable(opts);

    //descriptions
    $('#tblOver300Desc').DataTable(opts);
    $('#tblUnder150Desc').DataTable(opts);
    $('#tblMissingDesc').DataTable(opts);
    $('#tblDuplicateDesc').DataTable(opts);

    //recalc when switching tab
    $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function () {
      $.fn.dataTable.tables({visible: true, api: true}).columns.adjust().responsive.recalc();
    });
  });
</script>

<%- include('../partials/footer') %>
