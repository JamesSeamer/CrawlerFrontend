<%- include('../partials/header', { clients: [], activeClientId: null }) %>

<h1>Link Crawler</h1>

<% if (typeof message !== 'undefined' && message) { %>
  <div class="alert alert-warning"><%= message %></div>
<% } %>

<form id="crawlForm" class="card p-3">
  <div class="mb-3">
    <label for="clientSelect" class="form-label">Choose a client</label>
    <select id="clientSelect" class="form-select" required>
      <option value="" selected disabled>— Select client —</option>
      <% (clients || []).forEach(c => { %>
        <option value="<%= c.client_id %>" data-url="<%= c.client_url %>">
          <%= c.client_name %>
        </option>
      <% }) %>
    </select>
    <div id="urlPreview" class="form-text mt-1"></div>
  </div>

  <div class="d-flex gap-2">
    <button type="submit" class="btn btn-primary">Start Crawl</button>
  </div>
</form>

<div id="status" class="mt-3"></div>

<script>
  const form = document.getElementById('crawlForm');
  const select = document.getElementById('clientSelect');
  const statusDiv = document.getElementById('status');
  const urlPreview = document.getElementById('urlPreview');

  select.addEventListener('change', () => {
    const opt = select.options[select.selectedIndex];
    const url = opt?.dataset?.url || '';
    urlPreview.textContent = url ? `Crawl URL: ${url}` : '';
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const opt = select.options[select.selectedIndex];
    const crawlUrl = opt?.dataset?.url;
    if (!crawlUrl) {
      statusDiv.textContent = 'Please select a client with a valid URL.';
      return;
    }

    const endpoint = `http://localhost:3000/start-crawl?crawl_url=${encodeURIComponent(crawlUrl)}`;
    statusDiv.textContent = 'Crawling in progress…';
    console.log('Calling:', endpoint);

    try {
      const res = await fetch(endpoint, { method: 'GET' });
      const text = await res.text().catch(() => '');
      if (!res.ok) {
        throw new Error(`HTTP ${res.status} ${res.statusText} — ${text}`);
      }
      statusDiv.textContent = 'Crawl completed!';
      console.log('Crawl result:', text);
    } catch (err) {
      // If CORS, the error will be like "TypeError: Failed to fetch"
      console.error(err);
      statusDiv.textContent = `Error during crawl: ${err.message || err}`;
    }
  });
</script>
<%- include('../partials/footer') %>
